<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN">
<head>
    <title>流程设计器</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link href="../../css/workflow/workflow.css" rel="stylesheet" />
    <link href="../../css/workflow/flowdesign.css" rel="stylesheet" />


</head>
<body>

    <!-- fixed navbar -->
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <div class="pull-right">
                    <button class="btn btn-info" type="button" id="leipi_save">保存设计</button>
                    <button class="btn btn-danger" type="button" id="leipi_clear">清空连接</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3>消息提示</h3>
        </div>
        <div class="modal-body">
            <p>提示内容</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">我知道了</button>
        </div>
    </div>

    <div id="lineModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3>迁移条件</h3>
        </div>
        <div class="modal-body">
            <form>
                <div class="form-group">
                    <label for="input_condition_d" class="control-label">显示名称:</label>
                    <input type="text" class="form-control" value="" id="input_condition_d">
                </div>
                <div class="form-group">
                    <label for="input_condition" class="control-label">步骤结果:</label>
                    <input type="text" class="form-control" value="" id="input_condition">
                </div>
                <div class="form-group">
                    <label for="condition_expression" class="control-label">表达式:</label>
                    <textarea class="form-control" id="condition_expression"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true" onclick="delLine()">删除连线</button>
            <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true" onclick="saveCondition()">保存修改</button>
        </div>
    </div>

    <!-- attributeModal -->
    <div id="attributeModal" class="modal hide fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">流程设计器</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="flow_id" value="0" id="step_MainId" />
                    <input type="hidden" name="process_id" value="0" id="step_Id" />
                    <div class="tab-content">
                        <div class="form-inline tab-pane active" id="attrBasic">
                            <div class="form-group">
                                <label for="step_StepName">步骤名称：</label>
                                <input type="text" class="form-control" id="step_StepName" placeholder="步骤名称">
                            </div>
                            <hr />
                            <div class="form-group">
                                <div class="radio">
                                    <label>步骤类型：</label>
                                    <label class="radio-inline">
                                        <input type="radio" name="step_StepStatus" value="1">起始步骤
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="step_StepStatus" value="10">一般步骤
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" name="step_StepStatus" value="100">结束步骤
                                    </label>
                                </div>
                            </div>
                            <hr />
                            <div class="form-group">
                                <div class="checkbox">
                                    <label>功能：</label>
                                    <label class="checkbox-inline">
                                        <input name="step_function" type="checkbox" value="Agency" />转交
                                    </label>
                                    <label class="checkbox-inline">
                                        <input name="step_Circularize" type="checkbox" value="Circularize" />传阅
                                    </label>
                                </div>
                            </div>
                            <hr />
                            <div class="form-group">
                                <div class="radio">
                                    <label>后续步骤启动方式：</label>
                                    <label class="radio-inline">
                                        <input name="step_runmode" type="radio" checked="checked" value="auto" /><span>自动运行</span>
                                    </label>
                                    <label class="radio-inline">
                                        <input name="step_runmode" type="radio" value="select" /><span>基于选择</span>
                                    </label>
                                </div>
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_LinkCode">环节标识(第1或2或3...环节)：</label>
                                <input type="text" class="form-control" id="step_LinkCode" placeholder="环节标识(第1或2或3...环节)">
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_ShowTabIndex">要显示的Tab页(第1,2,3...Tab页)：</label>
                                <input type="text" class="form-control" id="step_ShowTabIndex" placeholder="要显示的Tab页(第1,2,3...Tab页)">
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_ReminderTimeout">环节时限（分钟）：</label>
                                <input type="text" class="form-control" id="step_ReminderTimeout" placeholder="环节时限（分钟）">
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_AuditNorm">代办参与者范围：</label>
                                <select name="child_id" id="step_AuditNorm" onchange="AuditNormChange()">
                                    <option value="Users">--指定用户--</option>
                                    <option value="Roles">--指定角色--</option>
                                    <option value="OUDetail">--本级领导--</option>
                                    <option value="ParentOUDetail">--上级领导--</option>
                                    <!--<option value="flow">--流程--</option>-->
                                    <option value="startuser">--发起人--</option>
                                    <option value="all">--全部人--</option>
                                </select>
                            </div>
                            <br />
                            <div class="form-group" id="div_AuditId">
                                <label>代办参与者：</label>
                                <select id="step_AuditId"></select>
                                <input id="RelationStepKey" type="text" placeholder="环节名称" value="" />
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_AuditNormRead">代阅参与者范围：</label>
                                <select id="step_AuditNormRead" onchange="AuditNormReadChange()">
                                    <option value="Users">--指定用户--</option>
                                    <option value="Roles">--指定角色--</option>
                                    <option value="OUDetail">--本级领导--</option>
                                    <option value="ParentOUDetail">--上级领导--</option>
                                    <!--<option value="flow">--流程--</option>-->
                                    <option value="startuser">--发起人--</option>
                                    <option value="all">--全部人--</option>
                                </select>
                            </div>
                            <br />
                            <div class="form-group" id="div_AuditIdRead">
                                <label>代阅参与者：</label>
                                <select id="step_AuditIdRead"></select>
                                <input id="RelationStepKeyRead" type="text" placeholder="环节名称" value="" />
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_SMSTemplateToDo">
                                    代办短信模版（工单编号：$WorkOrderCode$、工单名称：$WorkOrderName$、流程名称：$FlowName$、环节名称：$StepName$、提交人名称：$UserName$、提交人帐号：$UserCode$、提交时间：$StartTime$）：
                                </label>
                                <br />
                                <textarea class="form-control" rows="5" style="width:90%" id="step_SMSTemplateToDo" placeholder="代办短信模版..."></textarea>
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_SMSTemplateRead">
                                    代阅短信模版（工单编号：$WorkOrderCode$、工单名称：$WorkOrderName$、流程名称：$FlowName$、环节名称：$StepName$、提交人名称：$UserName$、提交人帐号：$UserCode$、提交时间：$StartTime$）：
                                </label>
                                <br />
                                <textarea class="form-control" rows="5" style="width:90%" id="step_SMSTemplateRead" placeholder="代阅短信模版..."></textarea>
                            </div>
                            <hr />
                            <div class="form-group">
                                <label for="step_Description">备注：</label>
                                <input type="text" class="form-control" id="step_Description" placeholder="备注">
                            </div>
                            <hr />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="form-group">
                        <a href="#" onclick="ModalSave();" class="btn btn-default" data-dismiss="modal" aria-hidden="true">确定保存</a>
                        <a href="#" class="btn btn-default" data-dismiss="modal" aria-hidden="true">取消</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--contextmenu div-->
    <div id="processMenu" style="display:none;">
        <ul>

            <li id="pmAttribute"><i class="icon-cog"></i>&nbsp;<span class="_label">属性</span></li>

            <li id="pmDelete"><i class="icon-trash"></i>&nbsp;<span class="_label">删除</span></li>

        </ul>
    </div>
    <div id="canvasMenu" style="display:none;">
        <ul>
            <li id="cmSave"><i class="icon-ok"></i>&nbsp;<span class="_label">保存设计</span></li>
            <li id="cmAdd"><i class="icon-plus"></i>&nbsp;<span class="_label">添加步骤</span></li>
            <li id="cmRefresh"><i class="icon-refresh"></i>&nbsp;<span class="_label">刷新 F5</span></li>

        </ul>
    </div>


    <div class="container mini-layout" id="flowdesign_canvas">
        <!--div class="process-step btn" style="left: 189px; top: 340px;"><span class="process-num badge badge-inverse"><i class="icon-star icon-white"></i>3</span> 步骤3</div-->
    </div> <!-- /container -->

    <div class="navbar navbar-fixed-bottom" style="color:gray;text-align:right;padding-right:10px">
        空白区域右键可添加步骤；步骤双击可修改属性；步骤内星星图标可以拖拉出连线；双击连线可修改参数。<br />
        每个流程必须有且仅有一个起始步骤和结束步骤；起始、结束步骤不会显示在单据当前流程状态，不需要配置审核人。<br />
        除了起始、结束步骤，每个步骤都必须至少有一条流程输入箭头线和流程流出箭头线。
    </div>

    
    <script src="../../js/workflow/jquery-1.7.2.min.js"></script>
    <script src="../../js/workflow/workflow.js"></script>
    <script src="../../js/workflow/bootstrap.js"></script>
    <script src="../../js/workflow/jquery-ui-1.9.2-min.js"></script>
    <script src="../../js/workflow/jquery.jsPlumb-1.3.16-all-min.js"></script>
    <script src="../../js/workflow/jquery.contextmenu.r2.js"></script>
    <script src="../../js/workflow/leipi.flowdesign.v3.js"></script>

    <script type="text/javascript">
        var the_flow_id = workflow.GetQueryString("fm");
        /*页面回调执行    callbackSuperDialog
            if(window.ActiveXObject){ //IE
                window.returnValue = globalValue
            }else{ //非IE
                if(window.opener) {
                    window.opener.callbackSuperDialog(globalValue) ;
                }
            }
            window.close();
        */
        function callbackSuperDialog(selectValue) {
            var aResult = selectValue.split('@leipi@');
            $('#' + window._viewField).val(aResult[0]);
            $('#' + window._hidField).val(aResult[1]);
            //document.getElementById(window._hidField).value = aResult[1];

        }
        /**
         * 弹出窗选择用户部门角色
         * showModalDialog 方式选择用户
         * URL 选择器地址
         * viewField 用来显示数据的ID
         * hidField 隐藏域数据ID
         * isOnly 是否只能选一条数据
         * dialogWidth * dialogHeight 弹出的窗口大小
         */
        function superDialog(URL, viewField, hidField, isOnly, dialogWidth, dialogHeight) {
            dialogWidth || (dialogWidth = 620)
            , dialogHeight || (dialogHeight = 520)
            , loc_x = 500
            , loc_y = 40
            , window._viewField = viewField
            , window._hidField = hidField;
            // loc_x = document.body.scrollLeft+event.clientX-event.offsetX;
            //loc_y = document.body.scrollTop+event.clientY-event.offsetY;
            if (window.ActiveXObject) { //IE
                var selectValue = window.showModalDialog(URL, self, "edge:raised;scroll:1;status:0;help:0;resizable:1;dialogWidth:" + dialogWidth + "px;dialogHeight:" + dialogHeight + "px;dialogTop:" + loc_y + "px;dialogLeft:" + loc_x + "px");
                if (selectValue) {
                    callbackSuperDialog(selectValue);
                }
            } else {  //非IE
                var selectValue = window.open(URL, 'newwindow', 'height=' + dialogHeight + ',width=' + dialogWidth + ',top=' + loc_y + ',left=' + loc_x + ',toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no');

            }
        }

        //审核类型下拉框事件
        function AuditNormChange() {
            switch ($("#step_AuditNorm").val()) {
                case "Users":
                    $("#RelationStepKey").hide();
                    $("#RelationStepKey").val("");
                    GetUserAll();
                    break;
                case "Roles":
                    $("#RelationStepKey").hide();
                    $("#RelationStepKey").val("");
                    GetRoleAll();
                    break;
                case "OUDetail":
                    $("#step_AuditId option").remove();
                    $("#RelationStepKey").val("");
                    $("#div_AuditId").hide();
                    break;
                case "flow":
                    $("#RelationStepKey").show();
                    GetFlow();
                    break;
                case "ParentOUDetail":
                    $("#step_AuditId option").remove();
                    $("#RelationStepKey").val("");
                    $("#div_AuditId").hide();
                    break;
                case "startuser":
                    $("#step_AuditId option").remove();
                    $("#RelationStepKey").val("");
                    $("#div_AuditId").hide();
                    break;
                case "all":
                    $("#step_AuditId option").remove();
                    $("#RelationStepKey").val("");
                    $("#div_AuditId").hide();
            }
        }

        //待阅 审核类型下拉框事件
        function AuditNormReadChange() {
            switch ($("#step_AuditNormRead").val()) {
                case "Users":
                    $("#RelationStepKeyRead").hide();
                    $("#RelationStepKeyRead").val("");
                    GetUserAll("Read");
                    break;
                case "Roles":
                    $("#RelationStepKeyRead").hide();
                    $("#RelationStepKeyRead").val("");
                    GetRoleAll("Read");
                    break;
                case "OUDetail":
                    $("#step_AuditIdRead option").remove();
                    $("#RelationStepKeyRead").val("");
                    $("#div_AuditIdRead").hide();
                    break;
                case "flow":
                    $("#RelationStepKeyRead").show();
                    GetFlow("Read");
                    break;
                case "ParentOUDetail":
                    $("#step_AuditIdRead option").remove();
                    $("#RelationStepKeyRead").val("");
                    $("#div_AuditIdRead").hide();
                    break;
                case "startuser":
                    $("#step_AuditIdRead option").remove();
                    $("#RelationStepKeyRead").val("");
                    $("#div_AuditIdRead").hide();
                    break;
                case "all":
                    $("#step_AuditIdRead option").remove();
                    $("#RelationStepKeyRead").val("");
                    $("#div_AuditIdRead").hide();
            }
        }

        //获取所有用户列表，绑定到下拉框
        function GetUserAll(type) {
            var control1 = "#div_AuditId";
            var control2 = "#step_AuditId";
            if (type == "Read") {
                control1 = "#div_AuditIdRead";
                control2 = "#step_AuditIdRead";
            }
            $(control1).show();
            $(control2 + " option").remove();
            //获取当前流传的所有步骤与关联
            $.ajax({
                url: '../../Workflow/GetUserAll',
                cache: false,
                async: false,
                type: 'Get',
                data: {},
                //dataType: "json",
                success: function (result) {
                    if (result != null && result.code == 0) {
                        for (var i = 0; i < result.data.length; i++) {
                            $(control2).append("<option value='" + result.data[i].id + "'>" + result.data[i].name + "</option>");
                        }
                    }
                }
            }).fail(function (xhr, textStatus, err) {
                alert(err);
            });
        }

        //获取所有角色列表，绑定到下拉框
        function GetRoleAll(type) {
            var control1 = "#div_AuditId";
            var control2 = "#step_AuditId";
            if (type == "Read") {
                control1 = "#div_AuditIdRead";
                control2 = "#step_AuditIdRead";
            }
            $(control1).show();
            $(control2 + " option").remove();

            //获取当前流传的所有步骤与关联
            $.ajax({
                url: '../../Workflow/GetRoleAll',
                cache: false,
                async: false,
                type: 'Get',
                data: {},
                //dataType: "json",
                success: function (result) {
                    if (result != null && result.code == 0) {
                        for (var i = 0; i < result.data.length; i++) {
                            $(control2).append("<option value='" + result.data[i].id + "'>" + result.data[i].name + "</option>");
                        }
                    }
                }
            }).fail(function (xhr, textStatus, err) {
                alert(err);
            });
        }

        function GetFlow(type) {
            var control1 = "#div_AuditId";
            var control2 = "#step_AuditId";
            if (type == "Read") {
                control1 = "#div_AuditIdRead";
                control2 = "#step_AuditIdRead";
            }
            $(control1).show();
            $(control2 + " option").remove();
            //获取当前流传的所有步骤与关联
            $.ajax({
                url: '../../Workflow/GetFlowConfigs',
                cache: false,
                async: false,
                type: 'Get',
                data: {},
                //dataType: "json",
                success: function (result) {
                    if (result != null && result.code == 0) {
                        for (var i = 0; i < result.data.length; i++) {
                            $(control2).append("<option value='" + result.data[i].id + "'>" + result.data[i].name + "</option>");
                        }
                    }
                }
            }).fail(function (xhr, textStatus, err) {
                alert(err);
            });
        }

        $(function () {
            var alertModal = $('#alertModal'), attributeModal = $("#attributeModal"), lineModal = $("#lineModal"), conditionNum = null, lineC = null;
            //消息提示
            mAlert = function (messages, s) {
                if (!messages) messages = "";
                if (!s) s = 2000;
                alertModal.find(".modal-body").html(messages);
                alertModal.modal('toggle');
                setTimeout(function () { alertModal.modal("hide") }, s);
            }

            //线条修改框
            lineCondition = function (c) {
                //if (!s) s = 2000;
                //alertModal.find(".modal-body").html(messages);

                conditionNum = null;
                lineC = c;
                $("#leipi_process_info input[type=hidden]").each(function (i) {
                    var processVal = $(this).val().split(",");
                    if (processVal.length == 2 && conditionNum == null) {
                        if (("window" + processVal[0]) == c.sourceId && ("window" + processVal[1]) == c.targetId) {
                            $("#input_condition").val($(this).attr("condition"));
                            $("#input_condition_d").val($(this).attr("condition_d"));
                            $("#condition_expression").val($(this).attr("expression"));
                            conditionNum = this;
                        }
                    }
                })

                lineModal.modal('toggle');
                // alertModal.modal("hide") ;
            }
            //保存修改的线条 condition值
            saveCondition = function () {
                if (conditionNum != null) {
                    $(conditionNum).attr("condition", $("#input_condition").val());
                    $("#input_condition").val("");
                    $(conditionNum).attr("condition_d", $("#input_condition_d").val());
                    $("#input_condition_d").val("");
                    $(conditionNum).attr("expression", $("#condition_expression").val());
                    $("#condition_expression").val("");
                }
            }
            //删除线条
            delLine = function () {
                if (lineC != null) {
                    jsPlumb.detach(lineC);
                    lineC = null;
                }
            }

            //属性设置
            attributeModal.on("hidden", function () {
                $(this).removeData("modal");//移除数据，防止缓存
            });

            ModalOpen = function (activeId) {
                var step = $("#window" + activeId);

                $("#step_Id").val(step.attr("process_id"));
                $("#step_MainId").val(step.attr("mainId"));
                $("#step_StepName").val(step.attr("stepName"));
                $("#step_AuditNorm").val(step.attr("auditNorm"));
                AuditNormChange();
                $("#step_AuditId").val(step.attr("auditId"));
                $("#step_AuditNormRead").val(step.attr("auditNormRead"));
                AuditNormReadChange();
                $("#step_AuditIdRead").val(step.attr("auditIdRead"));
                $("input[name='step_StepStatus'][value='" + step.attr("stepStatus") + "']").attr('checked', 'true');
                $("input[name='step_runmode'][value='" + step.attr("runMode") + "']").attr("checked", 'true');
                $("#step_Description").val(step.attr("description"));
                $("#RelationStepKey").val(step.attr("relationStepKey"));
                $("#step_LinkCode").val(step.attr("linkCode"));
                $("#step_ShowTabIndex").val(step.attr("showTabIndex"));
                $("#step_ReminderTimeout").val(step.attr("reminderTimeout"));
                $("#step_SMSTemplateToDo").val(step.attr("smsTemplateToDo"));
                $("#step_SMSTemplateRead").val(step.attr("smsTemplateRead"));

                //复选框
                var step_function = $("input[name='step_function']");
                if (step_function.val() == step.attr("function"))
                    step_function.attr("checked", 'true');
                else
                    step_function.removeAttr("checked");

                var step_Circularize = $("input[name='step_Circularize']");
                if (step_Circularize.val() == step.attr("circularize"))
                    step_Circularize.attr("checked", 'true');
                else
                    step_Circularize.removeAttr("checked");

                attributeModal.modal({
                    //remote: url
                });

                attributeModal.on('shown');
            }

            ModalSave = function () {
                var step = $("#window" + $("#step_Id").val());

                step.attr("stepName", $("#step_StepName").val());
                step.attr("auditNorm", $("#step_AuditNorm").val());
                step.attr("auditId", $("#step_AuditId").val());
                step.attr("auditNormRead", $("#step_AuditNormRead").val());
                step.attr("auditIdRead", $("#step_AuditIdRead").val());
                step.attr("stepStatus", $("input[name='step_StepStatus']:checked").val());
                step.attr("function", $("input[name='step_function']:checked").val() || "");
                step.attr("circularize", $("input[name='step_Circularize']:checked").val() || "");
                step.attr("runMode", $("input[name='step_runmode']:checked").val());
                step.attr("description", $("#step_Description").val());
                step.attr("relationStepKey", $("#RelationStepKey").val());
                step.attr("auditors", $("#step_Auditors").val());
                step.attr("linkCode", $("#step_LinkCode").val());
                step.attr("showTabIndex", $("#step_ShowTabIndex").val());
                step.attr("reminderTimeout", $("#step_ReminderTimeout").val());
                step.attr("smsTemplateToDo", $("#step_SMSTemplateToDo").val());
                step.attr("smsTemplateRead", $("#step_SMSTemplateRead").val());

                //var spans = step.html().split('</span>')
                step.find(".p_stepName").html($("#step_StepName").val());
                //step.html(spans[0] + "</span>&nbsp;" + $("#step_StepName").val());
            }

            //刷新页面
            function page_reload() {
                location.reload();
            }

            //初始化页面步骤们
            var processData = { "total": 0, "list": [] };

            //获取当前流传的所有步骤与关联
            $.ajax({
                url: '../../Workflow/GetStepAndPath',
                cache: false,
                async: false,
                type: 'Get',
                data: { mainId: the_flow_id },
                //dataType: "json",
                success: function (result) {
                    if (result != null && result.code == 0 && result.data != null) {
                        processData.total = result.data.length;
                        processData.list = result.data;
                    }
                    else {
                        processData.total = 2;
                        //var info = { "id": workflow.Guid.NewGuid().Value, "MainId": the_flow_id, "process_name": "起始", "process_to": "", "conditions": "", "icon": "icon-play", "style": "left:435.22px;top:53.32px;;color:#0e76a8;", "StepStatus": 1 };
                        var info = {
                            "auditId": "0",
                            "auditNorm": "Roles",
                            "auditIdRead": "0",
                            "auditNormRead": "Roles",
                            "auditors": 1,
                            "description": "起始",
                            "relationStepKey": "",
                            "mainId": the_flow_id,
                            "stepName": "起始",
                            "stepStatus": 1,
                            "conditions": "",
                            "id": workflow.Guid.NewGuid().Value,
                            "process_name": "起始",
                            "process_to": " ",
                            "openChoices": "close",
                            "power": "readonly",
                            "runMode": "auto",
                            "joinMode": "select",
                            "examineMode": "onlyone",
                            "percentage": "",
                            "linkCode": "0",
                            "showTabIndex": "",
                            "reminderTimeout": "",
                            "smsTemplateToDo": "",
                            "smsTemplateRead": "",
                            "style": "left:435.22px;top:53.32px;;color:#0e76a8;"
                        }
                        processData.list.push(info);
                        //info = { "id": workflow.Guid.NewGuid().Value, "MainId": the_flow_id, "process_name": "结束", "process_to": "", "conditions": "", "icon": "icon-stop", "style": "left:435.22px;top:596.17px;color:#0e76a8;", "StepStatus": 100 };
                        info = {
                            "auditId": "0",
                            "auditNorm": "Roles",
                            "auditIdRead": "0",
                            "auditNormRead": "Roles",
                            "auditors": 1,
                            "description": "结束",
                            "relationStepKey": "",
                            "mainId": the_flow_id,
                            "stepName": "结束",
                            "stepStatus": 100,
                            "conditions": "",
                            "id": workflow.Guid.NewGuid().Value,
                            "process_name": "结束",
                            "process_to": " ",
                            "openChoices": "close",
                            "power": "readonly",
                            "runMode": "auto",
                            "joinMode": "select",
                            "examineMode": "onlyone",
                            "percentage": "",
                            "linkCode": "100",
                            "showTabIndex": "",
                            "reminderTimeout": "",
                            "smsTemplateToDo": "",
                            "smsTemplateRead": "",
                            "style": "left:435.22px;top:596.17px;color:#0e76a8;"
                        }
                        processData.list.push(info);
                    }
                }
            }).fail(function (xhr, textStatus, err) {
                alert(err);
            });

            /*
            php 命名习惯 单词用下划线_隔开
            js 命名习惯：首字母小写 + 其它首字线大写
            */
            /*步骤数据*/
            //var processData = { "total": 5, "list": [{ "id": "61", "flow_id": "4", "process_name": "1234567891", "process_to": "63,64", "icon": "icon-ok", "style": "width:121px;height:41px;line-height:41px;color:#0e76a8;left:193px;top:132px;" }, { "id": "62", "flow_id": "4", "process_name": "\u5ba1\u62792", "process_to": "65", "icon": "icon-star", "style": "width:120px;height:30px;line-height:30px;color:#0e76a8;left:486px;top:337px;" }, { "id": "63", "flow_id": "4", "process_name": "\u5feb\u6377\u5ba1\u6279", "process_to": "65", "icon": "icon-star", "style": "width:120px;height:30px;line-height:30px;color:#0e76a8;left:193px;top:472px;" }, { "id": "64", "flow_id": "4", "process_name": "\u5ba1\u62791", "process_to": "62,65", "icon": "icon-star", "style": "width:120px;height:30px;line-height:30px;color:#ff66b5;left:486px;top:137px;" }, { "id": "65", "flow_id": "4", "process_name": "\u5f52\u6863\u6574\u7406\u4eba", "process_to": "", "icon": "icon-star", "style": "width:120px;height:30px;line-height:30px;color:#0e76a8;left:738px;top:472px;" }] };

            /*创建流程设计器*/
            var _canvas = $("#flowdesign_canvas").Flowdesign({
                "processData": processData
                /*,mtAfterDrop:function(params)
                {
                    //alert("连接："+params.sourceId +" -> "+ params.targetId);
                }*/
                /*画面右键*/
                              , canvasMenus: {
                                  "cmAdd": function (t) {
                                      var mLeft = $("#jqContextMenu").css("left"), mTop = $("#jqContextMenu").css("top");

                                      /*重要提示 start*/
                                      //alert("这里使用ajax提交，请参考官网示例，可使用Fiddler软件抓包获取返回格式1");
                                      /*重要提示 end */
                                      var info = { "id": workflow.Guid.NewGuid().Value, "mainId": the_flow_id, "process_name": "新增步骤", "process_to": "", "conditions": "", "icon": "", "style": "left:" + mLeft + ";top:" + mTop + ";color:#0e76a8;", StepStatus: 10 };
                                      //var url = "/index.php?s=/Flowdesign/add_process.html";
                                      //$.post(url,{"flow_id":the_flow_id,"left":mLeft,"top":mTop},function(data){

                                      //    if(!data.status)
                                      //    {
                                      //        mAlert(data.msg);
                                      //    }else if(!_canvas.addProcess(data.info))//添加
                                      //   {
                                      //        mAlert("添加失败");
                                      //   }

                                      //},'json');
                                      _canvas.addProcess(info);

                                  },
                                  "cmSave": function (t) {
                                      //var processInfo = _canvas.getProcessInfo();//连接信息
                                      var list = _canvas.getProcessInfo();
                                      //保存所有步骤与关联
                                      $.ajax({
                                          url: '../../Workflow/SaveStepAndPath',
                                          cache: false,
                                          async: false,
                                          type: 'Post',
                                          data: { stepList: list },
                                          //dataType: "json",
                                          success: function (result) {
                                              if (result.code==0) {
                                                  alert("保存成功");
                                              }
                                              else {
                                                  alert("保存失败");
                                              }
                                          }
                                      }).fail(function (xhr, textStatus, err) {
                                          alert("保存失败。");
                                      });

                                      /*重要提示 start*/
                                      //alert("这里使用ajax提交，请参考官网示例，可使用Fiddler软件抓包获取返回格式2");
                                      /*重要提示 end */

                                      //var url = "/index.php?s=/Flowdesign/save_canvas.html";
                                      //$.post(url, { "flow_id": the_flow_id, "process_info": processInfo }, function (data) {
                                      //    mAlert(data.msg);
                                      //}, 'json');
                                  },
                                  //刷新
                                  "cmRefresh": function (t) {
                                      location.reload();//_canvas.refresh();
                                  },
                                  /*"cmPaste": function(t) {
                                      var pasteId = _canvas.paste();//右键当前的ID
                                      if(pasteId<=0)
                                      {
                                        alert("你未复制任何步骤");
                                        return ;
                                      }
                                      alert("粘贴:" + pasteId);
                                  },*/
                                  //"cmHelp": function (t) {
                                  //    mAlert('<ul><li><a href="http://flowdesign.leipi.org/doc.html" target="_blank">流程设计器 开发文档</a></li><li><a href="http://formdesign.leipi.org/doc.html" target="_blank">表单设计器 开发文档</a></li><li><a href="http://formdesign.leipi.org/demo.html" target="_blank">表单设计器 示例DEMO</a></li></ul>', 20000);
                                  //}

                              }
                /*步骤右键*/
                              , processMenus: {
                                  /*
                                  "pmBegin":function(t)
                                  {
                                      var activeId = _canvas.getActiveId();//右键当前的ID
                                      alert("设为第一步:"+activeId);
                                  },
                                  "pmAddson":function(t)//添加子步骤
                                  {
                                        var activeId = _canvas.getActiveId();//右键当前的ID
                                  },
                                  "pmCopy":function(t)
                                  {
                                      //var activeId = _canvas.getActiveId();//右键当前的ID
                                      _canvas.copy();//右键当前的ID
                                      alert("复制成功");
                                  },*/
                                  "pmDelete": function (t) {
                                      if (confirm("你确定删除步骤吗？")) {
                                          var activeId = _canvas.getActiveId();//右键当前的ID
                                          _canvas.delProcess(activeId);
                                          /*重要提示 start*/
                                          //alert("这里使用ajax提交，请参考官网示例，可使用Fiddler软件抓包获取返回格式3");
                                          /*重要提示 end */

                                          //var url = "/index.php?s=/Flowdesign/delete_process.html";
                                          //$.post(url, { "flow_id": the_flow_id, "process_id": activeId }, function (data) {
                                          //    if (data.status == 1) {
                                          //        //清除步骤
                                          //        //_canvas.delProcess(activeId);
                                          //        //清除连接   暂时先保存设计 + 刷新 完成
                                          //        var processInfo = _canvas.getProcessInfo();//连接信息
                                          //        var url = "/index.php?s=/Flowdesign/save_canvas.html";
                                          //        $.post(url, { "flow_id": the_flow_id, "process_info": processInfo }, function (data) {
                                          //            location.reload();
                                          //        }, 'json');

                                          //    }
                                          //    mAlert(data.msg);
                                          //}, 'json');

                                          var list = _canvas.getProcessInfo();
                                          //保存所有步骤与关联
                                          $.ajax({
                                              url: '../../Workflow/SaveStepAndPath',
                                              cache: false,
                                              async: false,
                                              type: 'Post',
                                              data: { stepList: list },
                                              //dataType: "json",
                                              success: function (result) {
                                                  location.reload();
                                              }
                                          }).fail(function (xhr, textStatus, err) {
                                              alert("操作失败。");
                                          });
                                      }
                                  },
                                  "pmAttribute": function (t) {
                                      var activeId = _canvas.getActiveId();//右键当前的ID
                                      ModalOpen(activeId);
                                      /*重要提示 start*/
                                      //alert("这里要使用程序处理，并非简单html页面，如果无法显示，请建立虚拟站点");
                                      ///*重要提示 end */
                                      ////var url = "/index.php?s=/Flowdesign/attribute/id/"+activeId+".html";
                                      //var url = '/Public/js/flowdesign/attribute.html?id=' + activeId;
                                      //ajaxModal(url, function () {
                                      //    //alert('加载完成执行')
                                      //});
                                  },
                                  "pmForm": function (t) {
                                      var activeId = _canvas.getActiveId();//右键当前的ID

                                      /*重要提示 start*/
                                      alert("这里使用ajax提交，请参考官网示例，可使用Fiddler软件抓包获取返回格式4");
                                      /*重要提示 end */

                                      var url = "/index.php?s=/Flowdesign/attribute/op/form/id/" + activeId + ".html";
                                      ajaxModal(url, function () {
                                          //alert('加载完成执行')
                                      });
                                  },
                                  "pmJudge": function (t) {
                                      var activeId = _canvas.getActiveId();//右键当前的ID

                                      /*重要提示 start*/
                                      alert("这里使用ajax提交，请参考官网示例，可使用Fiddler软件抓包获取返回格式5");
                                      /*重要提示 end */

                                      var url = "/index.php?s=/Flowdesign/attribute/op/judge/id/" + activeId + ".html";
                                      ajaxModal(url, function () {
                                          //alert('加载完成执行')
                                      });
                                  },
                                  "pmSetting": function (t) {
                                      var activeId = _canvas.getActiveId();//右键当前的ID

                                      /*重要提示 start*/
                                      alert("这里要使用程序处理，并非简单html页面，如果无法显示，请建立虚拟站点");
                                      /*重要提示 end */

                                      //var url = "/index.php?s=/Flowdesign/attribute/op/style/id/"+activeId+".html";
                                      var url = 'Public/js/flowdesign/attribute.html?id=' + activeId;
                                      ajaxModal(url, function () {
                                          //alert('加载完成执行')
                                      });
                                  }
                              }
                              , fnRepeat: function () {
                                  //alert("步骤连接重复1");//可使用 jquery ui 或其它方式提示
                                  mAlert("步骤连接重复了，请重新连接");

                              }
                              , fnClick: function () {
                                  var activeId = _canvas.getActiveId();
                                  // mAlert("查看步骤信息 " + activeId);
                              }
                              , fnDbClick: function () {
                                  //和 pmAttribute 一样
                                  var activeId = _canvas.getActiveId();//右键当前的ID

                                  /*重要提示 start*/
                                  //alert("这里使用ajax提交，请参考官网示例，可使用Fiddler软件抓包获取返回格式6");
                                  /*重要提示 end */

                                  //var url = "/index.php?s=/Flowdesign/attribute/id/" + activeId + ".html";
                                  // var url = "index.html?s=Public/js/flowdesign/attribute.html";
                                  //var url = "/Flowdesign/attribute/id/" + activeId + ".html";

                                  ModalOpen(activeId);
                              }
            });




            /*保存*/
            $("#leipi_save").bind('click', function () {
                //var processInfo = _canvas.getProcessInfo();//连接信息

                var list = _canvas.getProcessInfo();
                //保存所有步骤与关联
                $.ajax({
                    url: '../../Workflow/SaveStepAndPath',
                    cache: false,
                    async: false,
                    type: 'Post',
                    data: { stepList: list },
                    //dataType: "json",
                    success: function (result) {
                        if (result.code==0) {
                            alert("保存成功");
                        }
                        else {
                            alert("保存失败");
                        }
                    }
                }).fail(function (xhr, textStatus, err) {
                    alert("保存失败");
                });


                ///*重要提示 start*/
                //alert("这里使用ajax提交，请参考官网示例，可使用Fiddler软件抓包获取返回格式7");
                ///*重要提示 end */


                //var url = "/index.php?s=/Flowdesign/save_canvas.html";
                //$.post(url, { "flow_id": the_flow_id, "process_info": processInfo }, function (data) {
                //    mAlert(data.msg);
                //}, 'json');
            });
            /*清除*/
            $("#leipi_clear").bind('click', function () {
                if (_canvas.clear()) {
                    //alert("清空连接成功");
                    mAlert("清空连接成功，你可以重新连接");
                } else {
                    //alert("清空连接失败");
                    mAlert("清空连接失败");
                }
            });



        });


    </script>
</body>
</html>